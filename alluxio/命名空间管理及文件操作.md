# 元数据
* 元数据包括文件系统树，文件的权限及块信息
* 两种存储元数据的方式：
    * ROCKS：基于RocksDB的磁盘上的元数据存储，通过在conf/alluxio-site.properties文件中定义alluxio.master.metastore=ROCKS可以显式配置此存储方式
    * HEAP：堆上的元数据村粗（默认存储方式）
## Rocks
*Rocks metastore混合使用内存和磁盘*

* 元数据最终写入磁盘，但是内存中的大型缓存会存储最近访问的元数据
* 缓存缓冲区写入，并在缓存填满时异步将其刷新到RocksDB
* 默认的高速缓存大小为1000万个inode,大约10G内存
* 缓存采用LRU（最近最少使用）策略进行替换

*ROCKS配置项*

* alluxio.master.metastore.dir:RocksDB写入数据的本地目录，默认值为${work_dir}/metastore
* alluxio.master.metastore.inode.cache.max.size:对inode缓存大小的硬性限制，默认值是10000000，每百万个inode大约需要1GB内存，若master内存充裕，可以适当的调整此项配置

*ROCKS高级调优配置*
* alluxio.master.metastore.inode.cache.evict.batch.size:用于将缓存修改刷新到RocksDB的批处理大小，默认值为1000
* alluxio.master.metastore.inode.cache.high.water.mark.ratio:开始移出缓存的最大缓存大小比率，默认值是0.85
* alluxio.master.metastore.inode.cache.low.water.mark.ratio:移出的最大缓存大小的比率，默认值是0.8
## Heap
*提供一致，快速的性能，所需要的内存随文件系统中的文件数量而扩展*
* 32GB的内存大约可以支持4000万个文件
* 可以通过在conf/alluxio-site.properties文件中定义alluxio.master.metastore=HEAP 

## HEAP和ROCKS的切换
* 两种存储方式的日志信息不同
* 切换存储方式时需要格式化alluxio日志，擦除所有元数据
* 如果在切换后需要保存现有数据，需要执行日志备份和还原

*切换存储方式*
* 备份： bin/alluxio fsadmin backup 会输出日志的存储路径${BACKUP_PATH}
* 停止master: bin/alluxio-stop.sh stop masters
* 在配置文件中更新存储方式: 修改alluxio.master.metastore
* 格式化masters: bin/alluxio formatMasters
* 重启masters: bin/alluxio-start.sh -i ${BASKUP_PATH} masters

# 统一命名空间
## 透明命名
* 在alluxio中创建文件时可以选择是否持久化到底层存储系统
* alluxio会透明的发现底层存储系统中的文件（非alluxio创建）
## UFS命名空间
*除了alluxio提供的统一名称空间之外，alluxio挂载的每个底层文件系统都有自己的名称空间*
* alluxio和UFS命名空间信息不同步
    * 在不通过alluxio的情况下更改了UFS名称空间中的文件
    * 需要一种同步机制在两个命名空间中进行同步
## 命名空间
* alluxio提供统一的命名空间，充当底层文件系统数据的缓存
    * 通过alluxio访问UFS文件和直接访问UFS文件，结果是一致的
    * alluxio保存文件和目录的元数据（UFS挂载）
    * alluxio根据实际需要访问UFS中的数据
* 默认情况下，alluxio希望对底层存储系统的修改都通过alluxio
## UFS元数据同步
* 当alluxio扫描UFS目录并为其加载子路径的元数据时，它将创建元数据的副本，以便将来无需从UFS加载操作。
    * alluxio.user.file.metadata.sync.interval:配置缓存的副本的生存期。默认值为-1，表示在初始加载后不再重新同步元数据，值为0表示每次操作都同步元数据，间隔越低，alluxio越快发现UFS的外部修改，但会降低性能。
* 元数据同步会保留每个UFS文件的指纹
    * 指纹包括文件大小和上次修改时间之类的信息
    * alluxio通过指纹检查底层文件是否发生修改，如果发生修改，则释放现有数据重新加载文件的元数据。
    * 如果在底层添加或者删除文件，alluxio会更新命名空间中的元数据
* UFS元数据同步可以根据需要对master的任何命令进行同步，例如：alluxio fs ls -R -Dalluxio.user.file.metadata.sync.interval=0
* 对于HDFS,alluxio支持主动同步
    * alluxio注册监听器，可以监听HDFS上的任何改动，当HDFS发生改动时，alluxio会进行同步。bin/alluxio fs startSync /syncDir
* 其他加载UFS文件的方法
    * alluxio.user.file.metadata.load.type  
        * 只会发先新文件，不会重新加载修改或删除的文件
        * ALWAYS:始终检查UFS中是否有新文件
        * ONCE：使用默认行为，每个目录仅扫描一次
        * NEVER：不扫描新文件
    * bin/alluxio fs -f /path
        * 作用等同于ALWAYS
# 文件操作
**alluxio fs**

*查看文件：*`bin/alluxion fs ls /path`

*查看文件内容：*`bin/alluxio fs cat /path`

*修改文件所属组：*`bin/alluxio fs chgrp groupname /filename`

*修改文件权限：*`bin/alluxio fs chmod 777 /filename`

*修改文件所属用户：*`bin/alluxio fs chown username /filename`

*从本地复制文件到alluxio：*`bin/alluxio fs copyFromLocal localFilePath alluxioFilePath`

*从alluxio复制文件到本地：*`bin/alluxio fs copyToLocal alluxioFilePath localFilePath`

*在alluxio上复制文件：*`bin/alluxio fs cp alluxioPath1 alluxioPath2`

*释放alluxio上指定路径下已缓存的数据：*`bin/alluxio fs free /path`

*在alluxio指定目录下创建目录：*`bin/alluxio fs mkdir /path`

*将底层存储系统挂载到alluxio上：*`bin/alluxio fs mount alluxioPath ufsPath`

*删除指定路径的文件：*`bin/alluxio fs tm  /path`
